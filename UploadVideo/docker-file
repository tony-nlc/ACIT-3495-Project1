# STAGE 1: Build the Go binary
FROM golang:1.21-alpine AS builder

# Install git/certificates (needed for some Go modules)
RUN apk add --no-cache git

WORKDIR /app

# Copy dependency files first (for better Docker layer caching)
COPY go.mod ./
# RUN go mod download  <-- Uncomment this if you have a go.mod file

# Copy the source code
COPY . .

# Build a statically linked binary
# CGO_ENABLED=0 ensures the binary doesn't rely on C libraries missing in Alpine
RUN CGO_ENABLED=0 GOOS=linux go build -o upload_app upload.go

# STAGE 2: Create the final lean image
FROM alpine:latest

# Add security: Don't run as root in production
RUN adduser -D-g '' appuser

WORKDIR /home/appuser

# Copy only the compiled binary from the builder
COPY --from=builder /app/upload_app .

# Create the storage directory and set permissions
RUN mkdir -p ./temp && chown -R appuser:appuser ./temp

# Use the non-root user
USER appuser

EXPOSE 8080

CMD ["./upload_app"]